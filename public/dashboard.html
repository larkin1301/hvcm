<!-- public/dashboard.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - HVC Monitor</title>
  <link rel="stylesheet" href="/style.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; }
    body.dashboard { display: flex; flex-direction: column; }
    header { flex: 0 0 auto; }
    #main { display: flex; flex: 1 1 auto; overflow: hidden; }
    #device-list { width: 250px; background: #f8f9fa; overflow-y: auto; border-right: 1px solid #ddd; }
    #device-list ul { list-style: none; padding: 0; margin: 0; }
    #device-list li { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #e9ecef; }
    #device-list li:hover { background: #e2e6ea; }
    #map { flex: 1 1 auto; }
  </style>
</head>
<body class="dashboard">
  <header>
    <div style="display:flex; justify-content: space-between; align-items: center; padding: 0 20px;">
      <span>Device Dashboard</span>
      <button id="logout-btn" style="width:100px; padding:8px 12px; background:#fff; color:#007bff; border:none; border-radius:4px; cursor:pointer;">Logout</button>
    </div>
  </header>
  <div id="main">
    <aside id="device-list">
      <ul id="list"></ul>
    </aside>
    <div id="map"></div>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Authentication check: redirect if not logged in
    async function checkAuth() {
      const res = await fetch('/api/devices', { method: 'GET' });
      if (res.status === 401) {
        window.location = '/login.html';
        return false;
      }
      return true;
    }

    // Logout handler
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('logout-btn').addEventListener('click', async () => {
        await fetch('/logout');
        window.location = '/login.html';
      });
    });

    (async () => {
      if (!await checkAuth()) return;
      const res = await fetch('/api/devices');
      const devices = await res.json();

      // Initialize map
      const map = L.map('map').setView([51.5, -0.1], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

      const markers = {};
      // Build map markers and list, skip duplicates
      const listEl = document.getElementById('list');

      devices.forEach(d => {
        if (markers[d.device_id]) return;
        const latlng = [d.latitude, d.longitude];
        const marker = L.marker(latlng).addTo(map)
          .bindPopup(`<b>${d.device_id}</b><br>Time: ${d.timestamp}<br>Alarm: ${d.alarm_state}<br>Lat: ${d.latitude}<br>Lon: ${d.longitude}<br>CPU Temp: ${d.cpu_temp}`);
        markers[d.device_id] = marker;

        // Create list item
        const li = document.createElement('li');
        li.innerHTML = `<b>${d.device_id}</b><br><small>Time: ${d.timestamp} | Alarm: ${d.alarm_state} | Lat: ${d.latitude} | Lon: ${d.longitude} | CPU Temp: ${d.cpu_temp}</small>`;
        li.addEventListener('click', () => {
          map.setView(latlng, 13);
          marker.openPopup();
        });
        listEl.appendChild(li);
      });
    })();
  </script>
</body>
</html>
